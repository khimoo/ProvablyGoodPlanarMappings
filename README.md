# Provably Good Planar Mappings

サマーインターンでRoiらによるリアルタイム画像変形のアルゴリズムを実装しました.

論文： https://scholar.google.com/citations?view_op=view_citation&hl=en&user=xC6XLaYAAAAJ&citation_for_view=xC6XLaYAAAAJ:UeHWp8X0CEIC

[v1](./v1/README.md)は2週間インターンで実装したものをそのまま公開してます.

[v2](./v2/README.md)はv1のコードをより良いものに修正しつつインターフェースも実装したものです.

それぞれ以下のコマンドで実行してください。(Nixは各自インストールしてください。)
```Bash
$ nix run github:khimoo/ProvablyGoodPlanarMappings?dir=v1
$ nix run github:khimoo/ProvablyGoodPlanarMappings?dir=v2
```

# アルゴリズムについて

画像をマウスを使ってぐにゃぐにゃ動かすためのアルゴリズムです。\
この手法の優れている部分は、メッシュの裏返りが発生しないことを数学的に保証しつつ、どの程度の歪みまで許容するのかなどをある程度自由に設定できる点です。しかも、それらの式を工夫することで最終的に凸最適化問題に落とし込んでおり、既存のソルバーを使用することで簡単にリアルタイム性を保証することができます。



これ以降はまだ書きかけです。AIに書かせた内容をまだ確認してない。

## 問題設定

ユーザーが平面上の関心領域 $\Omega \subset \mathbb{R}^2$（画像や2Dキャラクターなど）を、ハンドルを動かすことで変形させたいとします。理想的な変形写像 $f : \Omega \to \mathbb{R}^2$ は以下の最適化問題の解として定式化されます：

$$\min_f E_{\text{pos}}(f) + \lambda E_{\text{reg}}(f) \quad \text{s.t.} \quad D(f; x) \le K_{\max}, \quad \forall x \in \Omega$$

ここで $E_{\text{pos}}$ はハンドルの位置拘束エネルギー、$E_{\text{reg}}$ は正則化項、$D(f; x)$ は点 $x$ における歪み指標です。しかしこの問題は無限次元かつ無限個の制約を持つため、直接解くことはできません。

## 基底関数による写像の構成

写像 $f$ を有限個の基底関数 $\{f_i\}_{i=1}^{n}$ の線形結合で表現します：

$$f(x) = \sum_{i=1}^n c_i f_i(x)$$

これにより問題は有限次元の係数 $c$ に対する最適化に帰着します。基底関数には B-Spline、Thin-Plate Spline (TPS)、Gaussian などの滑らかな関数が使えます。基底関数自体が滑らかなので、生成される写像も自動的に滑らかになります（メッシュベース手法との大きな違い）。

## 歪みの定義と裏返りの条件

写像 $f$ の点 $x$ におけるヤコビ行列 $J_f(x)$ の最大・最小特異値をそれぞれ $\Sigma(x)$, $\sigma(x)$ とすると、歪み指標は以下のように定義されます：

- **等長歪み（isometric distortion）**: $D_{\text{iso}}(x) = \max\{\Sigma(x), 1/\sigma(x)\}$
  - 長さの保存度合いを測る。$D_{\text{iso}} = 1$ のとき剛体変換に近い
- **等角歪み（conformal distortion）**: $D_{\text{conf}}(x) = \Sigma(x) / \sigma(x)$
  - 角度の保存度合いを測る。$D_{\text{conf}} = 1$ のとき相似変換に近い

**裏返りが発生しない条件**は $\sigma(x) > 0$（すべての $x \in \Omega$ について）です。$\sigma(x) > 0$ ならば $\det J_f(x) \neq 0$ であり、連続性から符号が変わることはないため、局所的な単射性が保証されます。

## なぜ裏返りが発生しない歪み上界を自動で求められるのか

本手法の核心は、**コロケーション点（配置点）上での有限個の制約から、領域全体の歪みと単射性を数学的に保証できる**ことにあります。そのメカニズムは以下のとおりです。

### 1. 連続の度合い（modulus of continuity）の利用

特異値関数 $\Sigma(x)$, $\sigma(x)$ が**ω-連続**であること、すなわち

$$|\sigma(x) - \sigma(z)| \le \omega(\|x - z\|)$$

が成り立つことを示します。ここで $\omega$ は連続かつ単調増加で $\omega(0) = 0$ を満たす関数です。

### 2. 基底関数の勾配からの ω の計算

Lemma 2 により、$\nabla u$ と $\nabla v$ が $\omega$-連続ならば特異値関数は $2\omega$-連続です。さらに写像の係数 $c$ と基底関数の勾配の連続度 $\omega_{\nabla \mathcal{F}}$ から、具体的に

$$\omega = 2\, |||c|||\, \omega_{\nabla \mathcal{F}}$$

と計算できます。$\omega_{\nabla \mathcal{F}}$ は基底関数ごとに解析的に求まります：

| 基底関数 | $\omega_{\nabla \mathcal{F}}(t)$ |
|----------|----------------------------------|
| B-Spline | $\frac{4}{3\Delta^2} t$（$\Delta$ はグリッド間隔） |
| TPS | $t(5.8 + 5|\ln t|)$（局所的） |
| Gaussian | $t / s^2$（$s$ はスケールパラメータ） |

### 3. 充填距離を介した全域保証

コロケーション点集合 $Z$ の**充填距離** $h = \max_{x \in \Omega} \min_{z \in Z} \|x - z\|$（領域内の任意の点からコロケーション点への最大距離）を用いると、Lemma 1 により：

$$\sigma(x) \ge \sigma(z) - \omega(h), \qquad \Sigma(x) \le \Sigma(z) + \omega(h)$$

が成り立ちます。つまり、コロケーション点上で $D_{\text{iso}}(z) \le K$（すなわち $\Sigma(z) \le K$ かつ $\sigma(z) \ge 1/K$）を強制すれば、**領域内の任意の点**で

$$D_{\text{iso}}(x) \le \max\left\{ K + \omega(h),\; \frac{1}{1/K - \omega(h)} \right\}$$

が保証されます。特に $1/K > \omega(h)$ が成り立てば $\sigma(x) > 0$ となり、**裏返りが発生しないことが証明**されます。

### 4. 歪み制御の3つの戦略

上記の関係式から、以下の3通りの使い方ができます：

1. **コロケーション点 $Z$ と制約 $K$ が与えられたとき**：全域の最大歪み $K_{\max}$ を計算する
2. **$K$ と所望の $K_{\max}$ が与えられたとき**：必要な充填距離 $h$（＝コロケーション点の密度）を逆算する
3. **$Z$ と所望の $K_{\max}$ が与えられたとき**：コロケーション点上で強制すべき $K$ を逆算する

このように、基底関数の性質と係数から $\omega$ を計算し、コロケーション点の充填距離 $h$ との関係式を通じて、**裏返りを防ぐための適切な歪み上界が自動的かつ理論的に導出**されます。

## なぜリアルタイム性が維持できるのか

### 1. SOCP（二次錐計画法）による凸最適化

ヤコビ行列 $J_f(x)$ は係数 $c$ に対して**線形**です。この性質を利用し、歪み制約を **Second-Order Cone Program (SOCP)** として定式化します。

具体的には、$J_f$ の類似部分 $J_S f$ と反類似部分 $J_A f$ に分解し、特異値の制約を凸な錐制約に変換します。非凸になる部分（$\|J_S f\| \ge r$ の形の制約）は、**フレーム** $d_i$（単位ベクトル）を導入して半平面制約 $J_S f \cdot d_i \ge r$ に凸化します。フレームは各最適化ステップ後に $d_i = J_S f / \|J_S f\|$ と更新され、次のステップでの実行可能領域を最大化します。

SOCP は内点法で効率的に解くことができ、制約数・変数数に対してほぼ線形の計算時間で解が得られます。

### 2. アクティブセット法による制約の削減

すべてのコロケーション点（例：$200^2 = 40000$ 点）に対して同時に制約を課すのは計算コストが高すぎます。実際には、**大部分の点では歪みが十分小さく、制約が非活性**です。

本手法では**アクティブセット法**を採用し、以下のように動的に制約を管理します：

- コロケーション点の歪みを毎ステップ評価し、**局所最大値**を検出
- 歪みが閾値 $K_{\text{high}}$ を超えた点のみをアクティブセットに追加
- 歪みが $K_{\text{low}}$ を下回った点はアクティブセットから除去
- 安定化のため、少数の等間隔な点は常にアクティブに保持

この結果、**実際にアクティブになるコロケーション点は全体のごく一部**（典型的には数十〜数百点）であり、最適化問題のサイズが大幅に削減されます。すべての点が同時にアクティブになるのは、歪みが全域で一様に閾値を超えるという極めて稀な場合のみです。

### 3. ソフト位置拘束による実行可能性の保証

位置拘束をハード制約にすると、歪み上界との矛盾で実行不可能になる場合があります（例：2つのハンドルを $K$ 倍以上引き離した場合）。本手法では位置拘束を**ソフト制約**（エネルギー最小化）として扱うことで、常に実行可能な解が存在することを保証し、インタラクションの途切れを防ぎます。

### まとめ

| 課題 | 本手法の解決策 |
|------|---------------|
| 滑らかさ | メッシュレスな滑らかな基底関数を使用 |
| 裏返り防止の保証 | 連続の度合い $\omega$ と充填距離 $h$ の理論的関係式により全域で $\sigma(x) > 0$ を保証 |
| 歪み上界の自動決定 | $\omega$ を基底関数の解析的性質から計算し、3つの戦略で $K$ と $h$ を相互に導出 |
| リアルタイム性 | SOCP による凸最適化 ＋ アクティブセット法で制約数を大幅に削減 |
| 操作の安定性 | ソフト位置拘束 ＋ フレームの逐次更新による実行可能性の維持 |
